name: CVE Scanning for Node.js

permissions:
    contents: read
    id-token: write

on:
    workflow_dispatch:
    schedule:
        - cron: "0 8,18 * * 1-5"
    push:
        paths:
            - "**/package.json"
            - "**/package-lock.json"
            - ".github/workflows/node-cve-ignore-list.xml"
            - ".github/workflows/cve-scanning-node.yml"
    pull_request:
        paths:
            - "**/package.json"
            - "**/package-lock.json"
            - ".github/workflows/node-cve-ignore-list.xml"
            - ".github/workflows/cve-scanning-node.yml"

jobs:
    node-modules-scan:
        name: ${{ matrix.module-folder }}-node-scan
        runs-on: ubuntu-latest
        environment:
            name: code-scan
        continue-on-error: false
        strategy:
            matrix:
                module-folder: ["cli", "docs", "shared", "calm-visualizer"]
        steps:
            - name: Checkout
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
            - name: Set up Node
              uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
              with:
                  node-version: 22
            - name: Build project with NPM
              run: npm install --omit=dev --ignore-scripts
              working-directory: ${{ matrix.module-folder }}
            - name: Depcheck
              uses: dependency-check/Dependency-Check_Action@main
              id: Depcheck
              with:
                  project: "${{ matrix.module-folder }}"
                  path: "${{ matrix.module-folder }}"
                  format: "HTML"
                  out: "${{ matrix.module-folder }}-reports"
                  args: >
                      --suppression .github/node-cve-ignore-list.xml
                      --nodeAuditSkipDevDependencies
                      --nodePackageSkipDevDependencies
                      --failOnCVSS 5
                      --enableRetired
                      --ossIndexUsername ${{ vars.OSS_INDEX_USERNAME }}
                      --ossIndexPassword ${{ vars.OSS_INDEX_PASSWORD }}
            - run: |
                  echo `echo UPNAME=${{matrix.module-folder}} | tr '/' '-'` >> $GITHUB_ENV
              shell: bash
            - name: Upload Test results
              if: ${{ always() }}
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: Depcheck report ${{ env.UPNAME }}
                  path: ${{ github.workspace }}/${{ matrix.module-folder }}-reports
