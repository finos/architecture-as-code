name: CVE Scanning for Maven Projects

permissions:
    contents: read

on:
    workflow_dispatch:
    schedule:
        - cron: '0 8,18 * * 1-5'
    push:
        paths:
            - '**/pom.xml'
            - '.github/workflows/maven-cve-ignore-list.xml'
            - '.github/workflows/cve-scanning-maven.yml'
    pull_request:
        paths:
            - '**/pom.xml'
            - '.github/workflows/maven-cve-ignore-list.xml'
            - '.github/workflows/cve-scanning-maven.yml'

jobs:
    depchecktest:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                java-version: ['21']
                module-folder: ['calm-hub']
        steps:
            - name: Checkout
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

            - name: Setup JDK
              uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4
              with:
                  java-version: ${{ matrix.java-version }}
                  cache: maven
                  distribution: 'adopt'

            - name: Build with Maven
              run: mvn -DskipTests verify -Ddependency-check.skip=true
              working-directory: ${{ matrix.module-folder }}

            - name: Depcheck
              uses: dependency-check/Dependency-Check_Action@main
              id: Depcheck
              env:
                  JAVA_HOME: /opt/jdk
                  # Provide an NVD API key via repository/org secret to increase request rate limits.
                  # Create secret NVD_API_KEY in GitHub settings -> Secrets and variables -> Actions.
                  # If unset, dependency-check will fall back to limited anonymous NVD access.
                  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
              with:
                  project: '${{ matrix.module-folder }}'
                  path: '${{ matrix.module-folder }}'
                  format: 'HTML'
                  out: '${{ matrix.module-folder }}-reports'
                  args: >
                      --suppression .github/maven-cve-ignore-list.xml
                      --failOnCVSS 5
                      --enableRetired
                      --exclude "**/package.json"
                      --exclude "**/package-lock.json"
                      --disableNodeAudit
                      --disableYarnAudit
                      --disableRetireJS

            - name: Upload Test results
              if: ${{ always() }}
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: Depcheck report ${{ github.job }} ${{ matrix.module-folder }}
                  path: ${{ github.workspace }}/${{ matrix.module-folder }}-reports
